# üìã **Comprehensive Diet Simplification Refactor Plan**

Based on the diet simplification changes documented in `diet_simplification.MD`, here's a detailed plan for updating the entire application:

## **üîç Key Changes Summary:**
- **Removed tables**: `diet_variants`, `meals`, `user_meal_log`
- **Enhanced `diets` table**: Added `calories_total`, `macros`, `week_plan` (JSONB)
- **Simplified `user_current_diet`**: Now directly references `diets` table
- **Updated `diet_catalog_view`**: Now exposes new fields directly from `diets`

---

## **1. üìÅ Update Supabase TypeScript Types** - ‚úÖ **COMPLETED**

### **Files to Update:**
- `supabase.ts` ‚Üí Replace with `markdowns-plans/sql/new_supabase.ts`

### **Changes:**
- ‚úÖ **COMPLETED** - Replace entire file with new generated types
- ‚úÖ **COMPLETED** - New `diets` table structure with `calories_total`, `macros`, `week_plan`
- ‚úÖ **COMPLETED** - Removed `diet_variants`, `meals`, `user_meal_log` table types
- ‚úÖ **COMPLETED** - Updated `user_current_diet` without `diet_variant_id`
- ‚úÖ **COMPLETED** - Updated `diet_catalog_view` with new fields

**Status:** ‚úÖ **STEP 1 COMPLETED** - Supabase TypeScript types successfully updated. Build errors now correctly identify missing tables (e.g., `diet_variants`), confirming the new types are working.

---

## **2. üîß Update Type Definitions and Interfaces** - ‚úÖ **COMPLETED**

### **Files to Update:**
- ‚úÖ **COMPLETED** - `src/app/(app)/diets/page.tsx` (Diet interface)
- ‚úÖ **COMPLETED** - `src/app/(app)/diets/[dietId]/page.tsx` (DietDetail, DietVariant, Meal interfaces)
- ‚úÖ **COMPLETED** - `src/app/(app)/diets/favorites/page.tsx` (FavoriteDiet interface)

### **Changes:**

#### **Diet Interface Updates:**
```typescript
// OLD - Remove these fields
variant_count?: number | null;
min_calories?: number | null;
max_calories?: number | null;

// NEW - Add these fields
calories_total?: number | null;
macros?: Json | null;
week_plan?: Json | null;
```

#### **Remove Obsolete Interfaces:**
- ‚úÖ **COMPLETED** - `DietVariant` interface (no longer exists)
- ‚úÖ **COMPLETED** - `Meal` interface (replaced by week_plan JSONB)
- ‚úÖ **COMPLETED** - `MealPlan`, `DayPlan`, `WeekPlan` interfaces (replaced by week_plan structure)

#### **New Week Plan Structure:**
```typescript
interface WeekPlan {
  days: Array<{
    day_index: number;
    meals: Array<{
      name: string;
      calories: number;
      items: Array<{
        name: string;
        quantity: number;
        unit: string;
        alt_items?: Array<{
          name: string;
          quantity: number;
          unit: string;
        }>;
      }>;
    }>;
  }>;
}
```

**Status:** ‚úÖ **STEP 2 COMPLETED** - All type definitions and interfaces successfully updated. Build passes with no TypeScript errors. Updated Diet interface, removed obsolete interfaces, and updated UI components to use new schema fields.

---

## **3. üìÑ Refactor `/diets` Page** - ‚úÖ **COMPLETED**

### **File:** `src/app/(app)/diets/page.tsx`

### **Changes:**

#### **A. Update Diet Interface:**
- ‚úÖ **COMPLETED** - Add `calories_total`, `macros`, `week_plan` fields
- ‚úÖ **COMPLETED** - Remove `variant_count`, `min_calories`, `max_calories` fields

#### **B. Update Data Fetching:**
```typescript
// OLD - Using diet_catalog_view with variant aggregation
const { data, error } = await supabase
  .from("diet_catalog_view")
  .select("*")

// NEW - Use diet_catalog_view with new structure
const { data, error } = await supabase
  .from("diet_catalog_view")
  .select(`
    id,
    title,
    description,
    category,
    difficulty,
    duration_weeks,
    popularity_score,
    calories_total,
    macros,
    week_plan,
    tags,
    slug
  `)
```

#### **C. Update Filtering Logic:**
- ‚úÖ **COMPLETED** - Update calorie filtering to use `calories_total` instead of `min_calories`/`max_calories`
- ‚úÖ **COMPLETED** - Remove variant-related filtering logic

#### **D. Update DietCard Props:**
- ‚úÖ **COMPLETED** - Pass `calories_total` instead of `min_calories`/`max_calories`
- ‚úÖ **COMPLETED** - Remove variant-related props

**Status:** ‚úÖ **STEP 3 COMPLETED** - `/diets` page successfully refactored to use new simplified schema. Updated data fetching queries to use new `diet_catalog_view` structure with `calories_total`, `macros`, and `week_plan` fields. Build passes with no errors.

---

## **4. üçΩÔ∏è Refactor `/diets/[dietId]` Page** - ‚úÖ **COMPLETED**

### **File:** `src/app/(app)/diets/[dietId]/page.tsx`

### **Major Changes:**

#### **A. Remove Variant Logic:**
- ‚úÖ **COMPLETED** - Remove `selectedVariant` state
- ‚úÖ **COMPLETED** - Remove variant selection UI
- ‚úÖ **COMPLETED** - Remove `DietVariant` interface usage

#### **B. Update Data Fetching:**
```typescript
// OLD - Complex query with variants and meals
const { data: dietData, error: dietError } = await supabase
  .from("diets")
  .select(`
    *,
    variants:diet_variants(*),
    meals:meals(*)
  `)

// NEW - Simple query with new structure
const { data: dietData, error: dietError } = await supabase
  .from("diets")
  .select(`
    id,
    title,
    description,
    category,
    difficulty,
    duration_weeks,
    popularity_score,
    calories_total,
    macros,
    week_plan,
    tags,
    slug,
    is_public,
    created_at,
    updated_at
  `)
```

#### **C. Update UI Components:**
- ‚úÖ **COMPLETED** - Replace variant selection with direct diet display
- ‚úÖ **COMPLETED** - Update meal plan display to use `week_plan` JSONB structure
- ‚úÖ **COMPLETED** - Update macros display to use `macros` JSONB
- ‚úÖ **COMPLETED** - Update calorie display to use `calories_total`

#### **D. Update Follow Diet Logic:**
```typescript
// OLD - Using diet_variant_id
const { error } = await supabase
  .from("user_current_diet")
  .upsert({
    user_id: user.id,
    diet_variant_id: selectedVariant.id,
    is_active: true,
    started_at: new Date().toISOString()
  })

// NEW - Direct diet reference
const { error } = await supabase
  .from("user_current_diet")
  .upsert({
    user_id: user.id,
    diet_id: diet.id,
    is_active: true,
    started_at: new Date().toISOString()
  })
```

**Status:** ‚úÖ **COMPLETED** - Follow diet logic updated to use direct diet reference instead of variant ID.

#### **E. Update Meal Plan Rendering:**
- ‚úÖ **COMPLETED** - Parse `week_plan` JSONB structure
- ‚úÖ **COMPLETED** - Render days and meals from the new structure
- ‚úÖ **COMPLETED** - Handle `items` and `alt_items` arrays
- ‚úÖ **COMPLETED** - Display meal calories from the structure
- ‚úÖ **COMPLETED** - Implement Swap functionality for items with alternatives
- ‚úÖ **COMPLETED** - Add state management for tracking swapped items
- ‚úÖ **COMPLETED** - Show visual feedback for swapped items

**Status:** ‚úÖ **STEP 4 COMPLETED** - `/diets/[dietId]` page successfully refactored to use new simplified schema. Removed variant logic, updated data fetching, implemented meal plan rendering with `alt_items` support and Swap functionality. Build passes with no errors.

---

## **5. ‚ù§Ô∏è Refactor `/diets/favorites` Page** - ‚úÖ **COMPLETED**

### **File:** `src/app/(app)/diets/favorites/page.tsx`

### **Changes:**

#### **A. Update Data Fetching:**
```typescript
// OLD - Complex join with variants
const { data, error } = await supabase
  .from("favorites")
  .select(`
    diet_id,
    created_at,
    diets:diet_id (
      id,
      slug,
      title,
      description,
      tags,
      category,
      difficulty,
      duration_weeks,
      popularity_score,
      is_public,
      created_at,
      updated_at
    )
  `)

// NEW - Include new fields
const { data, error } = await supabase
  .from("favorites")
  .select(`
    diet_id,
    created_at,
    diets:diet_id (
      id,
      slug,
      title,
      description,
      tags,
      category,
      difficulty,
      duration_weeks,
      popularity_score,
      calories_total,
      macros,
      week_plan,
      is_public,
      created_at,
      updated_at
    )
  `)
```

#### **B. Update FavoriteDiet Interface:**
- ‚úÖ **COMPLETED** - Add new fields from simplified schema (inherited from Diet interface)
- ‚úÖ **COMPLETED** - Remove variant-related fields (inherited from Diet interface)

**Status:** ‚úÖ **STEP 5 COMPLETED** - `/diets/favorites` page successfully refactored to use new simplified schema. Updated data fetching query to include new fields (`calories_total`, `macros`, `week_plan`). The `FavoriteDiet` interface automatically inherited the updated `Diet` interface from Step 2. Build passes with no errors.

---

## **6. üé® Update UI Components**


### **Files to Update:**
- `src/components/diets/DietCard.tsx`
- `src/components/diets/FavoriteDietCard.tsx`

### **Changes:**

#### **A. DietCard Component:**
- ‚úÖ **COMPLETED** - Update props to include `calories_total`, `macros`, `week_plan` (inherited from Diet interface)
- ‚úÖ **COMPLETED** - Remove `min_calories`, `max_calories`, `variant_count` props (done in Step 2)
- ‚úÖ **COMPLETED** - Update calorie display logic (now uses `calories_total`)
- ‚úÖ **COMPLETED** - Update macros display (if shown) (inherited from Diet interface)

#### **B. FavoriteDietCard Component:**
- ‚úÖ **COMPLETED** - Same updates as DietCard (inherited from Diet interface)
- ‚úÖ **COMPLETED** - Ensure consistency with new schema (done in Step 2)

**Status:** ‚úÖ **STEP 6 COMPLETED** - UI components (`DietCard` and `FavoriteDietCard`) were already properly updated in Step 2 when the Diet interface was refactored. Both components now use `calories_total` instead of `min_calories`/`max_calories` and inherit all new schema fields through the updated Diet interface. Build passes with no errors.

---

## **7. üìö Update Documentation**

### **File:** `markdowns-plans/scope.MD`

### **Changes:**

#### **A. Update Database Schema Section:**
- ‚úÖ **COMPLETED** - Document removal of `diet_variants`, `meals`, `user_meal_log` tables
- ‚úÖ **COMPLETED** - Document new `diets` table structure with JSONB fields
- ‚úÖ **COMPLETED** - Update `user_current_diet` table documentation
- ‚úÖ **COMPLETED** - Update `diet_catalog_view` documentation

#### **B. Update Screen Specifications:**
- ‚úÖ **COMPLETED** - Update Screen 4.1 (Diet Catalog) to reflect new schema
- ‚úÖ **COMPLETED** - Update Screen 4.2 (Favorites) to reflect new schema  
- ‚úÖ **COMPLETED** - Update Screen 5.1 (Diet Details) to reflect new schema
- ‚úÖ **COMPLETED** - Remove variant-related functionality descriptions
- ‚úÖ **COMPLETED** - Update meal plan display specifications

#### **C. Update API Documentation:**
- ‚úÖ **COMPLETED** - Update database queries in screen specifications
- ‚úÖ **COMPLETED** - Update data structures and interfaces
- ‚úÖ **COMPLETED** - Update user flow descriptions

**Status:** ‚úÖ **STEP 7 COMPLETED** - Documentation successfully updated in `scope.MD` to reflect the new simplified schema. Updated database schema section, screen specifications, API documentation, and code examples to use the new `diets` table structure with JSONB fields (`calories_total`, `macros`, `week_plan`). Removed all references to obsolete tables (`diet_variants`, `meals`, `user_meal_log`) and updated all functional requirements and code examples.

---

## **8. üß™ Testing Considerations**

### **Areas to Test:**
- ‚úÖ Diet catalog loading and filtering
- ‚úÖ Diet detail page rendering
- ‚úÖ Favorites functionality
- ‚úÖ Follow diet functionality
- ‚úÖ Meal plan display
- ‚úÖ Macros display
- ‚úÖ Calorie filtering
- ‚úÖ Search and sorting

### **Edge Cases:**
- ‚úÖ Diets without `week_plan` data
- ‚úÖ Diets without `macros` data
- ‚úÖ Large `week_plan` JSONB structures
- ‚úÖ Alternative items in meal plans

---

## **9. üìã Implementation Order**

1. **Update Supabase types** (`supabase.ts`)
2. **Update type definitions** (Diet interfaces)
3. **Refactor `/diets` page** (catalog)
4. **Refactor `/diets/[dietId]` page** (details)
5. **Refactor `/diets/favorites` page** (favorites)
6. **Update UI components** (DietCard, FavoriteDietCard)
7. **Update documentation** (scope.MD)
8. **Testing and validation**

---

## **10. ‚ö†Ô∏è Breaking Changes**

### **Database Schema:**
- ‚ùå `diet_variants` table removed
- ‚ùå `meals` table removed
- ‚ùå `user_meal_log` table removed
- ‚úÖ `diets` table enhanced with JSONB fields
- ‚úÖ `user_current_diet` simplified

### **API Changes:**
- ‚ùå Variant-based queries no longer work
- ‚ùå Meal-based queries no longer work
- ‚úÖ Direct diet queries with new fields
- ‚úÖ JSONB parsing for `week_plan` and `macros`

---

## **11. üìù Example Week Plan JSON Structure**

Based on the documentation, the `week_plan` JSONB structure should follow this format:

```json
{
  "days": [
    {
      "day_index": 0,
      "meals": [
        {
          "name": "Breakfast",
          "calories": 400,
          "items": [
            {
              "name": "Eggs",
              "quantity": 2,
              "unit": "pcs",
              "alt_items": [
                { "name": "Oatmeal", "quantity": 50, "unit": "grams" },
                { "name": "Avocado", "quantity": 1, "unit": "pc" }
              ]
            },
            {
              "name": "Chicken",
              "quantity": 150,
              "unit": "grams",
              "alt_items": [
                { "name": "Steak", "quantity": 100, "unit": "grams" },
                { "name": "Fish", "quantity": 150, "unit": "grams" }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

---

## **12. üéØ Success Criteria**

### **Functional Requirements:**
- ‚úÖ All diet pages load without errors
- ‚úÖ Diet catalog displays correctly with new schema
- ‚úÖ Diet details show meal plans from JSONB structure
- ‚úÖ Favorites functionality works with new schema
- ‚úÖ Follow diet functionality works with direct diet reference
- ‚úÖ Filtering and search work with new fields

### **Performance Requirements:**
- ‚úÖ Page load times remain acceptable
- ‚úÖ JSONB parsing doesn't cause performance issues
- ‚úÖ Database queries are optimized for new schema

### **User Experience:**
- ‚úÖ No breaking changes in user interface
- ‚úÖ All existing functionality preserved
- ‚úÖ Improved simplicity in diet management

---

This comprehensive plan ensures a smooth transition from the complex variant-based system to the simplified, unified diet structure while maintaining all existing functionality.
